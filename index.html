<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive English Flashcards - Memorize & Quiz</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #f72585;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #17a2b8;
            --warning: #ff9f1c;
            --purple: #7b2cbf;
            --bg-color: #e0f7fa; /* Light Blue Background */
            --blue-btn: #007bff; /* Blue Button */
            --red-btn: #f44336;   /* Red Button */
            --header-bg: #023e8a;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: var(--bg-color);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            background: var(--header-bg);
            padding: 20px;
            border-radius: 15px;
            color: white;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .file-selector-section, .level-selector-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        #fileSelect {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: 2px solid var(--accent);
            margin-bottom: 15px;
        }
        .mode-selector {
            background: white;
            padding: 10px;
            border-radius: 50px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        .mode-btn, .level-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 50px;
            border: none;
            background-color: transparent;
            color: var(--header-bg);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px; /* Ensure buttons don't get too small */
        }
        .mode-btn.active {
            background-color: var(--header-bg);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 121, 107, 0.3);
        }
        .flashcard-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        #searchInput {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: 2px solid var(--accent);
            margin-bottom: 15px;
        }
        .btn {
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-size: 1rem;
        }
        .btn.blue { background: var(--blue-btn); }
        .btn.red { background: var(--red-btn); }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .card-container {
            perspective: 1000px;
            height: 400px;
            margin-bottom: 30px;
        }
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        .card.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .card-front {
            background: linear-gradient(135deg, #81d4fa, #4fc3f7);
            color: white;
        }
        .card-back {
            background: linear-gradient(135deg, #f1f8e9, #dcedc8);
            color: var(--dark);
            transform: rotateY(180deg);
            overflow-y: auto;
        }
        .quiz-view {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }
        .quiz-length-selector {
            margin: 20px 0;
            font-size: 1.2rem;
            font-weight: 500;
        }
        #quizLengthInput {
            width: 100px;
            padding: 10px;
            font-size: 1.2rem;
            text-align: center;
            border-radius: 8px;
            border: 2px solid var(--accent);
            margin-left: 10px;
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .quiz-score, .quiz-progress { font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .quiz-question { font-size: 1.3rem; margin-bottom: 20px; font-weight: 500; }
        #quizQuestionLevel1 { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #quizQuestionIcon { font-size: 4rem; }
        #quizQuestionWord { font-size: 2.5rem; font-weight: bold; }
        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .option-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--primary);
            color: var(--primary);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .option-btn:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
        }
        .option-btn.correct { background-color: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .option-btn.incorrect { background-color: var(--red-btn) !important; color: white !important; border-color: var(--red-btn) !important; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .word-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        .word {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .description { font-size: 1.1rem; margin-bottom: 20px; }
        .arabic-meaning { font-size: 1.8rem; font-weight: bold; color: var(--primary); direction: rtl; font-family: 'Tahoma', sans-serif; }
        .card-icon { font-size: 4rem; margin-bottom: 20px; }
        .pronounce-btn {
            background: none; border: none; font-size: 2.5rem; color: white; cursor: pointer;
            transition: transform 0.2s; padding: 0; line-height: 1;
        }
        .pronounce-btn:hover { transform: scale(1.1); }
        .navigation { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .progress { font-weight: bold; }
        .word-list { margin-top: 20px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; padding: 10px; }
        .word-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.2s ease; border-radius: 5px; }
        .word-item:last-child { border-bottom: none; }
        .word-item:hover { background-color: rgba(76, 201, 240, 0.1); }
        .word-item.active { background-color: var(--primary); color: white; font-weight: bold; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; background: var(--success); color: white; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); transform: translateX(120%); transition: transform 0.4s ease-in-out; z-index: 1000; display: flex; align-items: flex-start; gap: 10px; max-width: 350px; text-align: left; }
        .notification.error { background: var(--red-btn); }
        .notification.show { transform: translateX(0); }
        .hidden { display: none !important; }
        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
        .lang-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            background-color: #f0f0f0;
            padding: 5px;
            border-radius: 25px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        .lang-btn {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background-color: transparent;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .lang-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .controls-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group {
            display: flex;
            gap: 15px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        #speedControl {
            width: 150px;
        }
        #speedValue {
            font-weight: bold;
            color: var(--primary);
            min-width: 40px;
        }

        /* --- Game Styles --- */
        .game-menu {
            text-align: center;
        }
        .game-menu h2 {
            margin-bottom: 20px;
        }
        .game-menu .btn {
            width: 80%;
            max-width: 300px;
            margin: 10px auto;
            font-size: 1.2rem;
        }
        #matchingGameContainer, #hangmanGameContainer, #wordScrambleGameContainer, #spellingBeeGameContainer {
            min-height: 400px;
        }
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        #matchBoard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .match-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.1rem;
            background-color: #fafafa;
        }
        .match-item:hover {
            border-color: var(--primary);
            background-color: #f0f8ff;
        }
        .match-item.selected {
            border-color: var(--primary);
            background-color: var(--accent);
            color: white;
        }
        .match-item.correct {
            border-color: var(--success);
            background-color: var(--success);
            color: white;
            transform: scale(1.05);
            opacity: 0.5;
            pointer-events: none;
        }
        .match-item.incorrect {
            border-color: var(--red-btn);
            background-color: var(--red-btn);
            color: white;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Hangman Styles */
        #hangmanDrawing {
            width: 150px;
            height: 180px;
            margin: 0 auto 15px;
        }
        #hangmanDrawing .hg-part {
            stroke: var(--dark);
            stroke-width: 4;
            fill: none;
            stroke-linecap: round;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #hangmanDrawing .hg-part.draw {
            opacity: 1;
        }
        #hangmanWord {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .letter-box {
            width: 40px;
            height: 40px;
            border-bottom: 3px solid var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        #hangmanKeyboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 8px;
            max-width: 600px;
            margin: 0 auto;
        }
        .key {
            padding: 10px;
            font-size: 1.2rem;
            text-transform: uppercase;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .key:disabled {
            cursor: not-allowed;
        }
        .key.correct {
            background-color: var(--success);
            color: white;
        }
        .key.incorrect {
            background-color: var(--red-btn);
            color: white;
            opacity: 0.6;
        }

        /* Word Scramble Styles */
        #wordScrambleGameContainer { text-align: center; }
        #scrambledWord {
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 5px;
            color: var(--primary);
            margin: 20px 0;
            padding: 20px;
            background-color: #f0f8ff;
            border-radius: 10px;
        }
        #scrambleGuessInput {
            width: 80%;
            max-width: 400px;
            padding: 15px;
            font-size: 1.5rem;
            border-radius: 10px;
            border: 2px solid var(--accent);
            margin: 15px auto;
            text-align: center;
        }
        #scrambleControls .btn {
            margin: 0 10px;
        }
        
        /* Spelling Bee Styles */
        #spellingBeeGameContainer { 
            text-align: center; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #hearWordAgainBtn {
            font-size: 4rem;
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 20px;
        }
        #hearWordAgainBtn:hover {
            transform: scale(1.1);
        }
        #spellingBeeHint {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 25px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 10px;
            direction: rtl;
        }
        #spellingGuessInput {
            width: 90%;
            max-width: 450px;
            padding: 15px;
            font-size: 1.8rem;
            border-radius: 10px;
            border: 2px solid var(--accent);
            margin: 15px auto;
            text-align: center;
            text-transform: lowercase;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Interactive English Flashcards</h1>
            <div class="subtitle">Developed by Dr. Mazen Badawy ‚Äì Doctorate of English Teaching and Testing</div>
        </header>

        <section class="file-selector-section">
            <h2>Select a Word List</h2>
            <p>Choose an Excel file from the list below.</p>
            <div id="loadingSpinner" class="spinner hidden"></div>
            <select id="fileSelect" style="margin-top: 15px;"></select>
            <button id="loadFileBtn" class="btn blue" style="margin-top: 10px;">Load Selected File</button>
        </section>

        <section id="unitSelectorSection" class="hidden" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;">
            <h2>Select a Unit</h2>
            <select id="unitSelect" style="width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 10px; border: 2px solid var(--accent); margin-top: 10px;"></select>
        </section>

        <div id="appContainer" class="hidden">
            <div class="mode-selector">
                <button class="mode-btn active" id="memorizeModeBtn">üß† Memorize</button>
                <button class="mode-btn" id="searchModeBtn">üîç Search</button>
                <button class="mode-btn" id="quizModeBtn">üèÜ Quiz</button>
                <button class="mode-btn" id="gamesModeBtn">üéÆ Games</button>
            </div>

            <main class="main-content">
                 <div class="flashcard-section">
                     <!-- Search Section -->
                     <div id="searchSection" class="hidden">
                         <div class="lang-selector" style="margin-bottom: 15px; text-align: center;">
                             <button class="lang-btn active" data-lang="en">Search English</button>
                             <button class="lang-btn" data-lang="ar">Search Arabic</button>
                         </div>
                         <input type="text" id="searchInput" placeholder="Search words (use * for wildcard)...">
                         <div id="searchResults" class="word-list" style="margin-top: 0; margin-bottom: 20px; max-height: 250px;"></div>
                     </div>

                     <!-- Quiz Level Selector -->
                     <div id="levelSelectView" class="level-selector-section hidden">
                         <h2>Select Quiz Level</h2>
                         <div class="quiz-length-selector">
                             <label for="quizLengthInput">Number of Questions:</label>
                             <input type="number" id="quizLengthInput" value="20" min="4">
                         </div>
                         <button id="level1Btn" class="btn blue" style="width: 100%; margin: 10px 0;">Level 1: Word ‚ûî Meaning</button>
                         <button id="level2Btn" class="btn blue" style="width: 100%; margin: 10px 0;">Level 2: Description ‚ûî Word</button>
                     </div>

                     <!-- Games Section -->
                     <div id="gamesSection" class="hidden">
                         <div id="gameMenuView" class="game-menu">
                             <h2>Vocabulary Games</h2>
                             <button id="startMatchingGameBtn" class="btn blue">Matching Game</button>
                             <button id="startHangmanGameBtn" class="btn" style="background-color: var(--warning);">Hangman</button>
                             <button id="startWordScrambleGameBtn" class="btn" style="background-color: var(--accent);">Word Scramble</button>
                             <button id="startSpellingBeeGameBtn" class="btn" style="background-color: var(--purple);">Spelling Bee</button>
                         </div>
                         <div id="matchingGameContainer" class="hidden">
                             <div id="matchingGameHeader" class="game-header">
                                 <span id="matchScore">Score: 0</span>
                                 <button id="restartMatchingGameBtn" class="btn red">üîÑ New Game</button>
                             </div>
                             <div id="matchBoard">
                                 <div class="matching-column" id="matchWordsColumn"></div>
                                 <div class="matching-column" id="matchMeaningsColumn"></div>
                             </div>
                         </div>
                         <div id="hangmanGameContainer" class="hidden">
                           <div class="game-header">
                                <span id="hangmanLives">Lives: 6</span>
                                <button id="restartHangmanGameBtn" class="btn red">üîÑ New Game</button>
                            </div>
                           <svg id="hangmanDrawing">
                               <!-- Stand -->
                               <line class="hg-part" x1="20" y1="170" x2="100" y2="170" /> 
                               <line class="hg-part" x1="60" y1="170" x2="60" y2="20" />
                               <line class="hg-part" x1="60" y1="20" x2="140" y2="20" />
                               <line class="hg-part" x1="140" y1="20" x2="140" y2="50" />
                               <!-- Body Parts -->
                               <circle id="hg-head" class="hg-part" cx="140" cy="70" r="20" />
                               <line id="hg-body" class="hg-part" x1="140" y1="90" x2="140" y2="130" />
                               <line id="hg-arm1" class="hg-part" x1="140" y1="100" x2="110" y2="120" />
                               <line id="hg-arm2" class="hg-part" x1="140" y1="100" x2="170" y2="120" />
                               <line id="hg-leg1" class="hg-part" x1="140" y1="130" x2="110" y2="150" />
                               <line id="hg-leg2" class="hg-part" x1="140" y1="130" x2="170" y2="150" />
                           </svg>
                           <div id="hangmanWord"></div>
                           <div id="hangmanKeyboard"></div>
                         </div>
                         <div id="wordScrambleGameContainer" class="hidden">
                             <div class="game-header">
                                 <span id="scrambleScore">Score: 0</span>
                                 <button id="restartWordScrambleGameBtn" class="btn red">üîÑ New Game</button>
                             </div>
                             <div id="scrambledWord"></div>
                             <input type="text" id="scrambleGuessInput" placeholder="Type your guess...">
                             <div id="scrambleControls">
                                 <button id="submitScrambleBtn" class="btn blue">Submit</button>
                                 <button id="skipScrambleBtn" class="btn" style="background-color: var(--warning);">Skip</button>
                             </div>
                         </div>
                         <div id="spellingBeeGameContainer" class="hidden">
                            <div class="game-header">
                                <span id="spellingBeeScore">Score: 0</span>
                                <span id="spellingBeeLives">Lives: 5 ‚ù§Ô∏è</span>
                                <button id="restartSpellingBeeGameBtn" class="btn red">üîÑ New Game</button>
                            </div>
                            <button id="hearWordAgainBtn" title="Hear word again">üîä</button>
                            <div id="spellingBeeHint">Hint will appear here</div>
                            <input type="text" id="spellingGuessInput" placeholder="Type what you hear...">
                            <div id="spellingBeeControls">
                                <button id="submitSpellingBtn" class="btn blue">Submit</button>
                                <button id="skipSpellingBtn" class="btn" style="background-color: var(--warning);">Skip</button>
                            </div>
                         </div>
                     </div>

                     <div id="controlsSection" class="controls-section hidden">
                         <div class="control-group">
                             <label for="speedControl"><strong>Voice Speed:</strong></label>
                             <input type="range" id="speedControl" min="0.5" max="2" value="1" step="0.1">
                             <span id="speedValue">1.0x</span>
                         </div>
                         <div class="control-group checkbox-group">
                             <strong>Pronounce:</strong>
                             <label><input type="checkbox" id="pronounceWordCheck" checked> Word</label>
                             <label><input type="checkbox" id="pronounceArabicCheck"> Arabic</label>
                             <label><input type="checkbox" id="pronounceDescriptionCheck"> Description</label>
                         </div>
                     </div>

                     <div class="card-container" id="cardContainer">
                         <!-- Memorize View -->
                         <div class="card" id="memorizeView">
                             <div class="card-face card-front">
                                 <div class="card-icon" id="cardIcon">üìö</div>
                                 <div class="word-container">
                                     <div class="word" id="wordFront"></div>
                                     <button class="pronounce-btn" id="pronounceBtn" title="Pronounce word">üîä</button>
                                 </div>
                             </div>
                             <div class="card-face card-back">
                                 <div class="description" id="description"></div>
                                 <div class="arabic-meaning" id="arabicMeaning"></div>
                             </div>
                         </div>

                         <!-- Quiz View -->
                         <div id="quizView" class="quiz-view hidden">
                             <div class="quiz-header">
                                 <div class="quiz-progress" id="quizProgress">Question: 0/0</div>
                                 <div class="quiz-score" id="quizScore">üèÜ Score: 0/0</div>
                                 <button class="btn red" id="restartQuizBtn">üîÑ Restart</button>
                             </div>
                             <div class="quiz-question" id="quizQuestion">
                                 <span id="quizQuestionText"></span>
                                 <div id="quizQuestionLevel1" class="hidden">
                                     <div id="quizQuestionIcon"></div>
                                     <div id="quizQuestionWord"></div>
                                 </div>
                             </div>
                             <div class="quiz-options" id="quizOptions"></div>
                         </div>
                     </div>

                     <div class="navigation" id="memorizeNav">
                         <button class="btn red" id="prevBtn">‚¨ÖÔ∏è Previous</button>
                         <div class="progress" id="progress">0 / 0</div>
                         <button class="btn" id="shuffleBtn" style="background-color: var(--primary);">üîÄ Shuffle</button>
                         <button class="btn" id="autoplayBtn" style="background-color: var(--accent);">‚ñ∂Ô∏è Autoplay</button>
                         <button class="btn blue" id="nextBtn">Next ‚û°Ô∏è</button>
                     </div>

                     <div class="word-list" id="wordList"></div>
                 </div>
            </main>
        </div>
    </div>

    <div class="notification" id="notification">Notification</div>

    <script>
        // --- DOM Elements ---
        const fileSelect = document.getElementById('fileSelect');
        const loadFileBtn = document.getElementById('loadFileBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const unitSelectorSection = document.getElementById('unitSelectorSection');
        const unitSelect = document.getElementById('unitSelect');
        const appContainer = document.getElementById('appContainer');
        const cardContainer = document.getElementById('cardContainer');
        const memorizeView = document.getElementById('memorizeView');
        const levelSelectView = document.getElementById('levelSelectView');
        const level1Btn = document.getElementById('level1Btn');
        const level2Btn = document.getElementById('level2Btn');
        const quizView = document.getElementById('quizView');
        const card = document.getElementById('memorizeView');
        const wordFront = document.getElementById('wordFront');
        const description = document.getElementById('description');
        const arabicMeaning = document.getElementById('arabicMeaning');
        const cardIcon = document.getElementById('cardIcon');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const autoplayBtn = document.getElementById('autoplayBtn');
        const progress = document.getElementById('progress');
        const wordList = document.getElementById('wordList');
        const notification = document.getElementById('notification');
        const pronounceBtn = document.getElementById('pronounceBtn');
        const memorizeModeBtn = document.getElementById('memorizeModeBtn');
        const searchModeBtn = document.getElementById('searchModeBtn');
        const quizModeBtn = document.getElementById('quizModeBtn');
        const gamesModeBtn = document.getElementById('gamesModeBtn');
        const memorizeNav = document.getElementById('memorizeNav');
        const quizLengthInput = document.getElementById('quizLengthInput');
        const quizProgress = document.getElementById('quizProgress');
        const quizScore = document.getElementById('quizScore');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const quizQuestion = document.getElementById('quizQuestion');
        const quizQuestionText = document.getElementById('quizQuestionText');
        const quizQuestionLevel1 = document.getElementById('quizQuestionLevel1');
        const quizQuestionIcon = document.getElementById('quizQuestionIcon');
        const quizQuestionWord = document.getElementById('quizQuestionWord');
        const quizOptions = document.getElementById('quizOptions');
        const searchSection = document.getElementById('searchSection');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const langBtns = document.querySelectorAll('.lang-btn');
        const controlsSection = document.getElementById('controlsSection');
        const speedControl = document.getElementById('speedControl');
        const speedValue = document.getElementById('speedValue');
        const pronounceWordCheck = document.getElementById('pronounceWordCheck');
        const pronounceArabicCheck = document.getElementById('pronounceArabicCheck');
        const pronounceDescriptionCheck = document.getElementById('pronounceDescriptionCheck');
        // Game Elements
        const gamesSection = document.getElementById('gamesSection');
        const gameMenuView = document.getElementById('gameMenuView');
        // Matching Game
        const startMatchingGameBtn = document.getElementById('startMatchingGameBtn');
        const matchingGameContainer = document.getElementById('matchingGameContainer');
        const restartMatchingGameBtn = document.getElementById('restartMatchingGameBtn');
        const matchScoreEl = document.getElementById('matchScore');
        const matchWordsColumn = document.getElementById('matchWordsColumn');
        const matchMeaningsColumn = document.getElementById('matchMeaningsColumn');
        // Hangman Game
        const startHangmanGameBtn = document.getElementById('startHangmanGameBtn');
        const hangmanGameContainer = document.getElementById('hangmanGameContainer');
        const restartHangmanGameBtn = document.getElementById('restartHangmanGameBtn');
        const hangmanLivesEl = document.getElementById('hangmanLives');
        const hangmanDrawing = document.getElementById('hangmanDrawing');
        const hangmanWordEl = document.getElementById('hangmanWord');
        const hangmanKeyboard = document.getElementById('hangmanKeyboard');
        // Word Scramble Game
        const startWordScrambleGameBtn = document.getElementById('startWordScrambleGameBtn');
        const wordScrambleGameContainer = document.getElementById('wordScrambleGameContainer');
        const restartWordScrambleGameBtn = document.getElementById('restartWordScrambleGameBtn');
        const scrambleScoreEl = document.getElementById('scrambleScore');
        const scrambledWordEl = document.getElementById('scrambledWord');
        const scrambleGuessInput = document.getElementById('scrambleGuessInput');
        const scrambleControls = document.getElementById('scrambleControls');
        const submitScrambleBtn = document.getElementById('submitScrambleBtn');
        const skipScrambleBtn = document.getElementById('skipScrambleBtn');
        // Spelling Bee Elements
        const startSpellingBeeGameBtn = document.getElementById('startSpellingBeeGameBtn');
        const spellingBeeGameContainer = document.getElementById('spellingBeeGameContainer');
        const restartSpellingBeeGameBtn = document.getElementById('restartSpellingBeeGameBtn');
        const spellingBeeScoreEl = document.getElementById('spellingBeeScore');
        const spellingBeeLivesEl = document.getElementById('spellingBeeLives');
        const hearWordAgainBtn = document.getElementById('hearWordAgainBtn');
        const spellingBeeHint = document.getElementById('spellingBeeHint');
        const spellingGuessInput = document.getElementById('spellingGuessInput');
        const submitSpellingBtn = document.getElementById('submitSpellingBtn');
        const skipSpellingBtn = document.getElementById('skipSpellingBtn');


        // --- App State ---
        let allFlashcards = [];
        let flashcards = [];
        let currentCardIndex = 0;
        let currentMode = 'memorize';
        let searchLanguage = 'en'; // 'en' or 'ar'
        let isAutoplaying = false;
        let autoplayTimeout = null;
        let speechRate = 1.0;
        // Quiz State
        let currentQuizLevel = 1;
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let score = 0;
        // Matching Game State
        let selectedWordEl = null;
        let selectedMeaningEl = null;
        let matchScore = 0;
        let pairsToMatch = 0;
        // Hangman State
        let hangmanWordToGuess = '';
        let hangmanCardToGuess = null;
        let hangmanGuessedLetters = [];
        let hangmanWrongGuesses = 0;
        const HANGMAN_MAX_WRONG = 6;
        // Word Scramble State
        let scrambleWordToGuess = null;
        let scrambleScore = 0;
        // Spelling Bee State
        let spellingBeeCardToGuess = null;
        let spellingBeeScore = 0;
        let spellingBeeLives = 0;
        const SPELLING_BEE_MAX_LIVES = 5;

        const colorMap = {
            'red': '#ff0000', 'green': '#008000', 'blue': '#0000ff', 'yellow': '#ffff00',
            'orange': '#ffa500', 'purple': '#800080', 'pink': '#ffc0cb', 'black': '#000000',
            'white': '#ffffff', 'gray': '#808080', 'grey': '#808080', 'brown': '#a52a2a',
            'cyan': '#00ffff', 'magenta': '#ff00ff', 'lime': '#00ff00', 'maroon': '#800000',
            'navy': '#000080', 'olive': '#808000', 'teal': '#008080', 'silver': '#c0c0c0', 'gold': '#ffd700'
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', fetchExcelFilesFromGitHub);
        loadFileBtn.addEventListener('click', loadSelectedFile);
        unitSelect.addEventListener('change', (e) => filterAndDisplayCards(e.target.value));
        card.addEventListener('click', async () => {
            card.classList.toggle('flipped');
            if (isAutoplaying) return; 
            if (card.classList.contains('flipped')) {
                const cardData = flashcards[currentCardIndex];
                if (pronounceArabicCheck.checked && cardData.arabicMeaning) await pronounceAndDelay(cardData.arabicMeaning, 'ar-SA');
                if (pronounceDescriptionCheck.checked && cardData.description) await pronounceAndDelay(cardData.description, 'en-US');
            } else {
                window.speechSynthesis.cancel();
            }
        });
        prevBtn.addEventListener('click', showPreviousCard);
        nextBtn.addEventListener('click', showNextCard);
        shuffleBtn.addEventListener('click', shuffleCards);
        autoplayBtn.addEventListener('click', toggleAutoplay);
        pronounceBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (pronounceWordCheck.checked && wordFront.textContent) pronounceText(wordFront.textContent, 'en-US');
        });
        memorizeModeBtn.addEventListener('click', () => switchMode('memorize'));
        searchModeBtn.addEventListener('click', () => switchMode('search'));
        quizModeBtn.addEventListener('click', () => switchMode('quiz'));
        gamesModeBtn.addEventListener('click', () => switchMode('games'));
        searchInput.addEventListener('input', performSearch);
        level1Btn.addEventListener('click', () => { currentQuizLevel = 1; startQuiz(); });
        level2Btn.addEventListener('click', () => { currentQuizLevel = 2; startQuiz(); });
        restartQuizBtn.addEventListener('click', startQuiz);
        startMatchingGameBtn.addEventListener('click', startMatchingGame);
        restartMatchingGameBtn.addEventListener('click', startMatchingGame);
        startHangmanGameBtn.addEventListener('click', startHangmanGame);
        restartHangmanGameBtn.addEventListener('click', startHangmanGame);
        startWordScrambleGameBtn.addEventListener('click', startWordScrambleGame);
        restartWordScrambleGameBtn.addEventListener('click', startWordScrambleGame);
        submitScrambleBtn.addEventListener('click', checkScrambleGuess);
        skipScrambleBtn.addEventListener('click', () => {
            scrambleGuessInput.disabled = true;
            scrambleControls.querySelectorAll('button').forEach(btn => btn.disabled = true);
            const details = createWordDetailHTML(scrambleWordToGuess);
            showNotification(`The word was: ${scrambleWordToGuess.word}${details}`, false, 5000);
            setTimeout(nextScrambleWord, 5000);
        });
        scrambleGuessInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') checkScrambleGuess();
        });

        // Spelling Bee Listeners
        startSpellingBeeGameBtn.addEventListener('click', startSpellingBeeGame);
        restartSpellingBeeGameBtn.addEventListener('click', startSpellingBeeGame);
        hearWordAgainBtn.addEventListener('click', () => {
            if(spellingBeeCardToGuess) pronounceText(spellingBeeCardToGuess.word, 'en-US');
        });
        submitSpellingBtn.addEventListener('click', checkSpellingGuess);
        spellingGuessInput.addEventListener('keyup', e => {
            if (e.key === 'Enter') checkSpellingGuess();
        });
        skipSpellingBtn.addEventListener('click', () => {
            if(spellingBeeLives > 0) {
                 spellingBeeLives--;
                 updateSpellingBeeStats();
                 const details = createWordDetailHTML(spellingBeeCardToGuess);
                 showNotification(`The word was: ${spellingBeeCardToGuess.word}${details}`, true, 5000);
                 if (spellingBeeLives > 0) {
                     setTimeout(nextSpellingBeeWord, 5000);
                 } else {
                     endSpellingBeeGame(false);
                 }
            }
        });


        langBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                langBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                searchLanguage = btn.dataset.lang;
                searchInput.placeholder = searchLanguage === 'en' ? 'Search words (use * for wildcard)...' : 'ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (ÿßÿ≥ÿ™ÿÆÿØŸÖ * ŸÑŸÑÿ®ÿ≠ÿ´)...';
                searchInput.dir = searchLanguage === 'ar' ? 'rtl' : 'ltr';
                searchInput.value = '';
                performSearch(); 
            });
        });

        speedControl.addEventListener('input', (e) => {
            speechRate = parseFloat(e.target.value);
            speedValue.textContent = `${speechRate.toFixed(1)}x`;
        });

        // --- Functions ---
        
        async function fetchExcelFilesFromGitHub() {
            const repoOwner = 'mazen19812002';
            const repoName = 'Flashcards';
            const repoPath = ''; // The path in your repo, empty for root
            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${repoPath}`;

            loadingSpinner.classList.remove('hidden');
            fileSelect.classList.add('hidden');
            loadFileBtn.classList.add('hidden');

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                const files = await response.json();
                
                const excelFiles = files.filter(file => file.type === 'file' && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')));

                fileSelect.innerHTML = '';
                if (excelFiles.length === 0) {
                    fileSelect.innerHTML = '<option value="">No Excel files found in repository.</option>';
                    loadFileBtn.disabled = true;
                    return;
                }
                
                excelFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.download_url;
                    option.textContent = file.name;
                    fileSelect.appendChild(option);
                });
                loadFileBtn.disabled = false;

            } catch (error) {
                console.error('Error fetching files from GitHub:', error);
                showNotification('Could not load file list from GitHub. Please check the repository path and your internet connection.', true, 6000);
                fileSelect.innerHTML = '<option value="">Error loading files.</option>';
                loadFileBtn.disabled = true;
            } finally {
                loadingSpinner.classList.add('hidden');
                fileSelect.classList.remove('hidden');
                loadFileBtn.classList.remove('hidden');
            }
        }

        async function loadSelectedFile() {
            const selectedFileUrl = fileSelect.value;
            if (!selectedFileUrl) {
                showNotification('Please select a file to load.', true);
                return;
            }

            loadingSpinner.classList.remove('hidden');
            unitSelectorSection.classList.add('hidden');
            appContainer.classList.add('hidden');

            try {
                const response = await fetch(selectedFileUrl);
                 if (!response.ok) {
                    throw new Error(`Failed to download file: ${response.status} ${response.statusText}`);
                }
                const data = await response.arrayBuffer();
                processExcelData(data);
            } catch (error) {
                console.error('Error loading Excel file:', error);
                showNotification('Failed to load the selected Excel file.', true, 5000);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function filterAndDisplayCards(unit) {
            stopAutoplay();
            if (unit === 'all') {
                flashcards = [...allFlashcards];
            } else {
                flashcards = allFlashcards.filter(card => card.unit === unit);
            }

            if (flashcards.length === 0) {
                showNotification(`No cards found for ${unit}. Showing all cards instead.`, true);
                flashcards = [...allFlashcards];
                unitSelect.value = 'all';
            }

            quizLengthInput.max = flashcards.length;
            quizLengthInput.value = Math.min(20, flashcards.length);

            currentCardIndex = 0;
            updateWordList();
            displayCurrentCard();

            const hasCards = flashcards.length > 0;
            [prevBtn, nextBtn, shuffleBtn, autoplayBtn].forEach(btn => btn.disabled = !hasCards);

            if (!appContainer.classList.contains('hidden')) {
                switchMode('memorize');
            }
        }

        function switchMode(mode) {
            if (flashcards.length === 0) {
                showNotification("Please load a card set first.", true);
                return;
            }
            stopAutoplay();
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${mode}ModeBtn`).classList.add('active');

            const views = [
                searchSection, levelSelectView, cardContainer, memorizeNav, wordList, 
                quizView, memorizeView, controlsSection, gamesSection, 
                matchingGameContainer, hangmanGameContainer, wordScrambleGameContainer, spellingBeeGameContainer
            ];
            views.forEach(view => view.classList.add('hidden'));

            if (mode === 'memorize') {
                [controlsSection, cardContainer, memorizeView, memorizeNav, wordList].forEach(v => v.classList.remove('hidden'));
                displayCurrentCard();
            } else if (mode === 'search') {
                [searchSection, cardContainer, memorizeView].forEach(v => v.classList.remove('hidden'));
                searchInput.placeholder = searchLanguage === 'en' ? 'Search words (use * for wildcard)...' : 'ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (ÿßÿ≥ÿ™ÿÆÿØŸÖ * ŸÑŸÑÿ®ÿ≠ÿ´)...';
                searchInput.dir = searchLanguage === 'ar' ? 'rtl' : 'ltr';
                showSearchPromptCard();
            } else if (mode === 'quiz') {
                levelSelectView.classList.remove('hidden');
            } else if (mode === 'games') {
                gamesSection.classList.remove('hidden');
                gameMenuView.classList.remove('hidden');
            }
        }

        function processExcelData(data) {
             try {
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                const headers = jsonData[0].map(h => String(h).toLowerCase().trim());
                const unitIndex = headers.indexOf('unit');
                const wordIndex = headers.indexOf('word');
                const iconIndex = headers.indexOf('icon');
                const descIndex = headers.indexOf('description');
                const arabicIndex = headers.indexOf('arabic meaning');
                
                if (wordIndex === -1) throw new Error("Column 'Word' not found in your Excel file.");
                if (unitIndex === -1) throw new Error("A 'Unit' column is required in your Excel file.");

                allFlashcards = jsonData.slice(1).map(row => ({
                    unit: (row[unitIndex] || '').toString(),
                    word: (row[wordIndex] || '').toString(), 
                    icon: row[iconIndex], 
                    description: row[descIndex], 
                    arabicMeaning: row[arabicIndex]
                })).filter(card => card.unit && card.word && card.arabicMeaning && /^[a-zA-Z\s'-]+$/.test(card.word));

                if (allFlashcards.length < 8) {
                    appContainer.classList.add('hidden'); 
                    unitSelectorSection.classList.add('hidden');
                    throw new Error("At least 8 valid English words with Arabic meanings and Unit names are needed.");
                }

                showNotification(`‚úÖ Loaded ${allFlashcards.length} cards successfully!`);
                
                populateUnitSelector();
                unitSelectorSection.classList.remove('hidden');
                
                filterAndDisplayCards('all'); 
                
                appContainer.classList.remove('hidden');
                switchMode('memorize');

             } catch (error) {
                console.error('Error parsing Excel data:', error);
                showNotification(error.message, true, 5000);
             }
        }

        function populateUnitSelector() {
            const units = ['all', ...new Set(allFlashcards.map(card => card.unit))];
            unitSelect.innerHTML = '';
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit === 'all' ? 'All Units' : unit;
                unitSelect.appendChild(option);
            });
        }

        function pronounceText(text, lang) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = speechRate;
                window.speechSynthesis.speak(utterance);
            } else {
                showNotification('Text-to-speech not supported.', true);
            }
        }

        function pronounceAndDelay(text, lang) {
            return new Promise(resolve => {
                if (!text || !('speechSynthesis' in window)) {
                    resolve();
                    return;
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = speechRate;
                utterance.onend = resolve;
                utterance.onerror = resolve; 
                window.speechSynthesis.speak(utterance);
            });
        }

        function displayCurrentCard() {
            if (flashcards.length === 0) {
                // Handle no cards state gracefully
                wordFront.textContent = 'No Cards';
                cardIcon.textContent = 'ü§∑‚Äç‚ôÇÔ∏è';
                description.textContent = 'No cards available for the selected unit.';
                arabicMeaning.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿ∑ÿßŸÇÿßÿ™';
                progress.textContent = `0 / 0`;
                 if(card.classList.contains('flipped')) card.classList.remove('flipped');
                return;
            };
            const cardData = flashcards[currentCardIndex];
            const wordLower = (cardData.word || '').toLowerCase();
            
            wordFront.textContent = cardData.word || 'N/A';
            cardIcon.textContent = cardData.icon || 'üìù';
            
            if (colorMap[wordLower]) {
                cardIcon.style.color = colorMap[wordLower];
                cardIcon.style.textShadow = wordLower === 'white' ? '0 0 5px #000, 0 0 5px #000' : 'none';
            } else {
                cardIcon.style.color = '';
                cardIcon.style.textShadow = 'none';
            }

            description.textContent = cardData.description || 'No description.';
            arabicMeaning.textContent = cardData.arabicMeaning || '...'; 
            progress.textContent = `${currentCardIndex + 1} / ${flashcards.length}`;
            
            const currentWord = cardData.word;
            document.querySelectorAll('.word-item').forEach(item => {
                item.classList.toggle('active', item.textContent === currentWord);
            });

            if(card.classList.contains('flipped')) card.classList.remove('flipped');
        }

        function showPreviousCard() {
            stopAutoplay();
            if (flashcards.length === 0) return;
            currentCardIndex = (currentCardIndex - 1 + flashcards.length) % flashcards.length;
            displayCurrentCard();
        }

        function showNextCard() {
            if (flashcards.length === 0) return;
            currentCardIndex = (currentCardIndex + 1) % flashcards.length;
            displayCurrentCard();
        }

        function shuffleCards() {
            stopAutoplay();
            if (flashcards.length < 2) {
                showNotification("Not enough cards to shuffle.", true);
                return;
            }
            for (let i = flashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
            }
            currentCardIndex = 0;
            updateWordList();
            displayCurrentCard();
            showNotification("üîÄ Cards have been shuffled!");
        }

        function updateWordList() {
            wordList.innerHTML = '';
            if(flashcards.length === 0) return;

            flashcards.forEach((cardData) => {
                const item = document.createElement('div');
                item.className = 'word-item';
                item.textContent = cardData.word;
                item.addEventListener('click', () => {
                    stopAutoplay();
                    const originalIndex = flashcards.findIndex(card => card.word === cardData.word);
                    if (originalIndex !== -1) {
                        currentCardIndex = originalIndex;
                        displayCurrentCard();
                    }
                });
                wordList.appendChild(item);
            });
            const currentItem = wordList.children[currentCardIndex];
            if (currentItem) {
                currentItem.classList.add('active');
            }
        }

        function showSearchPromptCard() {
            wordFront.textContent = 'Search a Word';
            cardIcon.textContent = 'üîç';
            cardIcon.style.color = '';
            cardIcon.style.textShadow = 'none';
            description.textContent = 'Use the search box above to find a word.';
            arabicMeaning.textContent = 'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÉŸÑŸÖÿ©';
            if(card.classList.contains('flipped')) card.classList.remove('flipped');
        }

        function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }

            const regex = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&').replace(/\*/g, '.*'), 'i');
            const searchKey = searchLanguage === 'en' ? 'word' : 'arabicMeaning';
            const results = flashcards.filter(card => regex.test(card[searchKey]));
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="word-item" style="cursor:default; background:none;">No results found.</div>';
                return;
            }
            const displayKey = searchLanguage === 'en' ? 'word' : 'arabicMeaning';
            results.forEach(cardData => {
                const item = document.createElement('div');
                item.className = 'word-item';
                item.textContent = cardData[displayKey]; 
                 if (searchLanguage === 'ar') {
                    item.style.direction = 'rtl';
                }
                item.addEventListener('click', () => {
                    const originalIndex = flashcards.findIndex(card => card.word === cardData.word && card.arabicMeaning === cardData.arabicMeaning);
                    if (originalIndex !== -1) {
                        currentCardIndex = originalIndex;
                        displayCurrentCard();
                    }
                });
                searchResults.appendChild(item);
            });
        }

        function startQuiz() {
            levelSelectView.classList.add('hidden');
            cardContainer.classList.remove('hidden');
            quizView.classList.remove('hidden');
            memorizeView.classList.add('hidden');
            score = 0;
            currentQuizIndex = 0;
            let desiredLength = parseInt(quizLengthInput.value);
            if (isNaN(desiredLength) || desiredLength < 4) { desiredLength = 4; }
            if (desiredLength > flashcards.length) { desiredLength = flashcards.length; }
             if (flashcards.length < 4) {
                showNotification("You need at least 4 cards in this unit to start a quiz.", true);
                switchMode('memorize'); // Go back to a safe mode
                return;
            }
            const shuffled = [...flashcards].sort(() => 0.5 - Math.random());
            quizQuestions = shuffled.slice(0, desiredLength);
            displayQuizQuestion();
        }

        function displayQuizQuestion() {
            if (currentQuizIndex >= quizQuestions.length) {
                const percentage = score / quizQuestions.length * 100;
                let stars = '', icon = '';
                if (percentage >= 90) { stars = '‚≠ê‚≠ê‚≠ê'; icon = 'üèÜ'; } 
                else if (percentage >= 70) { stars = '‚≠ê‚≠ê'; icon = 'ü•á'; } 
                else if (percentage >= 50) { stars = '‚≠ê'; icon = 'üëç'; } 
                else { stars = 'Try Again!'; icon = 'üòî'; }
                quizQuestionLevel1.classList.add('hidden');
                quizQuestionText.classList.remove('hidden');
                quizQuestionText.innerHTML = `<div style="text-align: center;"><div style="font-size: 4rem; margin-bottom: 15px;">${icon}</div><h2>Quiz Complete!</h2></div>`;
                quizOptions.innerHTML = `<div style="grid-column: 1 / -1; text-align: center;"><p style="font-size: 1.5rem; text-align: center; margin-bottom: 20px;">Your final score is ${score} out of ${quizQuestions.length}.</p><div style="font-size: 2.5rem;">${stars}</div></div>`;
                quizScore.innerHTML = `üèÜ Final Score: ${score}/${quizQuestions.length}`;
                quizProgress.textContent = "Finished!";
                return;
            }
            quizQuestionText.innerHTML = '';
            quizProgress.textContent = `Question: ${currentQuizIndex + 1} / ${quizQuestions.length}`;
            quizScore.innerHTML = `üèÜ Score: ${score} / ${quizQuestions.length}`;
            const questionData = quizQuestions[currentQuizIndex];
            quizQuestionText.classList.toggle('hidden', currentQuizLevel === 1);
            quizQuestionLevel1.classList.toggle('hidden', currentQuizLevel === 2);
            let correctAnswer, options = new Set();
            if (currentQuizLevel === 1) {
                const wordLower = (questionData.word || '').toLowerCase();
                quizQuestionIcon.textContent = questionData.icon || 'üìù';
                quizQuestionWord.textContent = questionData.word;
                quizQuestionIcon.style.color = colorMap[wordLower] || '';
                quizQuestionIcon.style.textShadow = wordLower === 'white' ? '0 0 5px #000' : 'none';
                correctAnswer = questionData.arabicMeaning;
                options.add(correctAnswer);
                const distractors = allFlashcards.filter(f => f.arabicMeaning !== correctAnswer);
                while (options.size < 4 && distractors.length > 0) {
                     options.add(distractors.splice(Math.floor(Math.random() * distractors.length), 1)[0].arabicMeaning);
                }
            } else { // Level 2
                quizQuestionText.textContent = questionData.description;
                correctAnswer = questionData.word;
                options.add(correctAnswer);
                const distractors = allFlashcards.filter(f => f.word !== correctAnswer);
                while (options.size < 4 && distractors.length > 0) {
                     options.add(distractors.splice(Math.floor(Math.random() * distractors.length), 1)[0].word);
                }
            }
            const shuffledOptions = Array.from(options).sort(() => 0.5 - Math.random());
            quizOptions.innerHTML = '';
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                if(currentQuizLevel === 1) button.style.direction = 'rtl';
                button.addEventListener('click', () => checkAnswer(option, correctAnswer));
                quizOptions.appendChild(button);
            });
        }
        
        function checkAnswer(selectedOption, correctAnswer) {
            const buttons = quizOptions.querySelectorAll('.option-btn');
            buttons.forEach(button => {
                button.disabled = true;
                if (button.textContent === correctAnswer) button.classList.add('correct');
            });
            if (selectedOption === correctAnswer) {
                score++;
                showNotification("Correct!", false, 1500);
            } else {
                buttons.forEach(button => {
                  if (button.textContent === selectedOption) button.classList.add('incorrect');
                });
                showNotification("Incorrect!", true, 1500);
            }
            currentQuizIndex++;
            setTimeout(displayQuizQuestion, 2000);
        }

        function showNotification(message, isError = false, duration = 3000) {
            const icon = isError ? '‚ùå' : '‚úÖ';
            notification.innerHTML = `<span>${icon}</span> ${message}`;
            notification.classList.toggle('error', isError);
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), duration);
        }

        // --- Autoplay Functions ---
        function toggleAutoplay() {
            isAutoplaying ? stopAutoplay() : startAutoplay();
        }

        async function playCardSequence() {
            if (!isAutoplaying) return;
            const cardData = flashcards[currentCardIndex];
            if (pronounceWordCheck.checked && cardData.word) await pronounceAndDelay(cardData.word, 'en-US');
            if (!isAutoplaying) return;
            card.classList.add('flipped');
            await new Promise(r => setTimeout(r, 800));
            if (!isAutoplaying) return;
            if (pronounceArabicCheck.checked && cardData.arabicMeaning) await pronounceAndDelay(cardData.arabicMeaning, 'ar-SA');
            if (!isAutoplaying) return;
            if (pronounceDescriptionCheck.checked && cardData.description) await pronounceAndDelay(cardData.description, 'en-US');
        }

        async function autoplayLoop() {
            if (!isAutoplaying) return;
            await playCardSequence();
            if (!isAutoplaying) return;
            await new Promise(r => setTimeout(r, 1500));
            if (!isAutoplaying) return;
            showNextCard();
            if (isAutoplaying) {
               autoplayTimeout = setTimeout(autoplayLoop, 800);
            }
        }

        function startAutoplay() {
            if (!flashcards.length) return;
            isAutoplaying = true;
            autoplayBtn.innerHTML = '‚èπÔ∏è Stop';
            autoplayBtn.style.backgroundColor = 'var(--red-btn)';
            [prevBtn, nextBtn, shuffleBtn].forEach(b => b.disabled = true);
            wordList.style.pointerEvents = 'none';
            autoplayLoop();
        }

        function stopAutoplay() {
            if (!isAutoplaying) return;
            isAutoplaying = false;
            clearTimeout(autoplayTimeout);
            autoplayTimeout = null;
            window.speechSynthesis.cancel();
            autoplayBtn.innerHTML = '‚ñ∂Ô∏è Autoplay';
            autoplayBtn.style.backgroundColor = 'var(--accent)';
            [prevBtn, nextBtn, shuffleBtn].forEach(b => b.disabled = false);
            wordList.style.pointerEvents = 'auto';
        }

        function createWordDetailHTML(card) {
            if (!card) return '';
            const descriptionText = card.description ? `<b>Description:</b> ${card.description}` : '';
            return `<br><div style="margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.5); padding-top: 8px;">
                        <span style="direction: rtl; display: block; text-align: right;"><b>ÿßŸÑŸÖÿπŸÜŸâ:</b> ${card.arabicMeaning}</span>
                        <small>${descriptionText}</small>
                    </div>`;
        }

        // --- Game Functions ---
        function startMatchingGame() {
            [gameMenuView, hangmanGameContainer, wordScrambleGameContainer, spellingBeeGameContainer].forEach(v => v.classList.add('hidden'));
            matchingGameContainer.classList.remove('hidden');
            matchScore = 0;
            updateMatchScore();

            const GAME_SIZE = 8;
            if (flashcards.length < GAME_SIZE) {
                showNotification(`You need at least ${GAME_SIZE} cards in this unit to play.`, true);
                switchMode('memorize');
                return;
            }

            const gameCards = [...flashcards].sort(() => 0.5 - Math.random()).slice(0, GAME_SIZE);
            pairsToMatch = gameCards.length;

            const words = gameCards.map(c => ({ text: c.word, matchId: c.word }));
            const meanings = gameCards.map(c => ({ text: c.arabicMeaning, matchId: c.word }));

            renderMatchColumn(matchWordsColumn, words.sort(() => 0.5 - Math.random()), 'word');
            renderMatchColumn(matchMeaningsColumn, meanings.sort(() => 0.5 - Math.random()), 'meaning');
        }

        function renderMatchColumn(columnEl, items, type) {
            columnEl.innerHTML = '';
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'match-item';
                itemEl.textContent = item.text;
                itemEl.dataset.matchId = item.matchId;
                itemEl.dataset.type = type;
                if (type === 'meaning') itemEl.style.direction = 'rtl';
                itemEl.addEventListener('click', handleMatchItemClick);
                columnEl.appendChild(itemEl);
            });
        }

        function handleMatchItemClick(e) {
            const clickedItem = e.target;
            if (clickedItem.classList.contains('correct')) return;
            const type = clickedItem.dataset.type;

            if (type === 'word') {
                if (selectedWordEl) selectedWordEl.classList.remove('selected');
                selectedWordEl = clickedItem;
                selectedWordEl.classList.add('selected');
            } else { // meaning
                if (selectedMeaningEl) selectedMeaningEl.classList.remove('selected');
                selectedMeaningEl = clickedItem;
                selectedMeaningEl.classList.add('selected');
            }

            if (selectedWordEl && selectedMeaningEl) {
                document.getElementById('matchBoard').style.pointerEvents = 'none';
                if (selectedWordEl.dataset.matchId === selectedMeaningEl.dataset.matchId) {
                    [selectedWordEl, selectedMeaningEl].forEach(el => el.classList.add('correct'));
                    selectedWordEl = null;
                    selectedMeaningEl = null;
                    matchScore++;
                    updateMatchScore();
                    showNotification('Match found!', false, 1000);
                    if (matchScore === pairsToMatch) {
                        setTimeout(() => showNotification('üéâ Congratulations! You found all matches!', false, 5000), 1200);
                    }
                    document.getElementById('matchBoard').style.pointerEvents = 'auto';
                } else {
                    [selectedWordEl, selectedMeaningEl].forEach(el => el.classList.add('incorrect'));
                    setTimeout(() => {
                        [selectedWordEl, selectedMeaningEl].forEach(el => el.classList.remove('incorrect', 'selected'));
                        selectedWordEl = null;
                        selectedMeaningEl = null;
                        document.getElementById('matchBoard').style.pointerEvents = 'auto';
                    }, 800);
                }
            }
        }
        
        function updateMatchScore() {
            matchScoreEl.textContent = `Score: ${matchScore}`;
        }

        function startHangmanGame() {
            [gameMenuView, matchingGameContainer, wordScrambleGameContainer, spellingBeeGameContainer].forEach(v => v.classList.add('hidden'));
            hangmanGameContainer.classList.remove('hidden');

            hangmanWrongGuesses = 0;
            hangmanGuessedLetters = [];
            
            const validHangmanWords = flashcards.filter(c => !c.word.includes(' '));
            if (validHangmanWords.length === 0) {
                showNotification("No single-word cards available in this unit for Hangman.", true);
                switchMode('games');
                return;
            }
            hangmanCardToGuess = validHangmanWords[Math.floor(Math.random() * validHangmanWords.length)];
            hangmanWordToGuess = hangmanCardToGuess.word.toUpperCase();
            
            updateHangmanLives();
            drawHangmanWord();
            createHangmanKeyboard();
            document.querySelectorAll('#hangmanDrawing .hg-part').forEach((part, index) => {
                if (index < 4) {
                    part.classList.add('draw');
                } else {
                    part.classList.remove('draw');
                }
            });
        }

        function drawHangmanWord() {
            hangmanWordEl.innerHTML = hangmanWordToGuess.split('').map(letter => `
                <div class="letter-box">
                    ${hangmanGuessedLetters.includes(letter) || !/[A-Z]/.test(letter) ? letter : ''}
                </div>
            `).join('');
        }

        function createHangmanKeyboard() {
            hangmanKeyboard.innerHTML = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(key => 
                `<button class="key">${key}</button>`
            ).join('');
            hangmanKeyboard.addEventListener('click', handleHangmanGuess);
        }

        function handleHangmanGuess(e) {
            if (e.target.tagName !== 'BUTTON') return;
            const letter = e.target.textContent;
            e.target.disabled = true;

            if (hangmanWordToGuess.includes(letter)) {
                e.target.classList.add('correct');
                hangmanGuessedLetters.push(letter);
            } else {
                e.target.classList.add('incorrect');
                hangmanWrongGuesses++;
                updateHangmanLives();
                document.querySelectorAll('#hangmanDrawing .hg-part')[hangmanWrongGuesses + 3].classList.add('draw');
            }
            drawHangmanWord();
            checkHangmanWinLoss();
        }
        
        function updateHangmanLives() {
            hangmanLivesEl.textContent = `Lives: ${HANGMAN_MAX_WRONG - hangmanWrongGuesses}`;
        }

        function checkHangmanWinLoss() {
            const isWon = hangmanWordToGuess.split('').every(letter => hangmanGuessedLetters.includes(letter) || !/[A-Z]/.test(letter));
            if (isWon) {
                const details = createWordDetailHTML(hangmanCardToGuess);
                showNotification(`üéâ You won! The word was ${hangmanWordToGuess}.${details}`, false, 6000);
                hangmanKeyboard.removeEventListener('click', handleHangmanGuess);
            } else if (hangmanWrongGuesses >= HANGMAN_MAX_WRONG) {
                const details = createWordDetailHTML(hangmanCardToGuess);
                showNotification(`üò≠ You lost. The word was: ${hangmanWordToGuess}.${details}`, true, 7000);
                hangmanWordEl.innerHTML = hangmanWordToGuess.split('').map(letter => `<div class="letter-box">${letter}</div>`).join('');
                hangmanKeyboard.removeEventListener('click', handleHangmanGuess);
            }
        }
        
        function startWordScrambleGame() {
            [gameMenuView, matchingGameContainer, hangmanGameContainer, spellingBeeGameContainer].forEach(v => v.classList.add('hidden'));
            wordScrambleGameContainer.classList.remove('hidden');
            scrambleScore = 0;
            updateScrambleScore();
            nextScrambleWord();
        }
        
        function nextScrambleWord() {
             if (flashcards.length === 0) {
                showNotification("No cards in this unit to play Word Scramble.", true);
                switchMode('games');
                return;
            }
            scrambleWordToGuess = flashcards[Math.floor(Math.random() * flashcards.length)];
            let word = scrambleWordToGuess.word;
            let scrambled = word.split('').sort(() => 0.5 - Math.random()).join('');
            while (scrambled.toLowerCase() === word.toLowerCase() && word.length > 1) {
                scrambled = word.split('').sort(() => 0.5 - Math.random()).join('');
            }
            scrambledWordEl.textContent = scrambled;
            scrambleGuessInput.value = '';
            scrambleGuessInput.disabled = false;
            scrambleGuessInput.focus();
            scrambleControls.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }

        function checkScrambleGuess() {
            const guess = scrambleGuessInput.value.trim();
            if (!guess) return;

            const isCorrect = guess.toLowerCase() === scrambleWordToGuess.word.toLowerCase();
            
            scrambleGuessInput.disabled = true;
            scrambleControls.querySelectorAll('button').forEach(btn => btn.disabled = true);

            if (isCorrect) {
                const details = createWordDetailHTML(scrambleWordToGuess);
                showNotification(`‚úÖ Correct! ${scrambleWordToGuess.word}${details}`, false, 4000);
                scrambleScore++;
                updateScrambleScore();
                setTimeout(nextScrambleWord, 4000);
            } else {
                const details = createWordDetailHTML(scrambleWordToGuess);
                showNotification(`‚ùå Incorrect. The word was: ${scrambleWordToGuess.word}${details}`, true, 5000);
                scrambleGuessInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    scrambleGuessInput.style.animation = '';
                    nextScrambleWord();
                }, 5000);
            }
        }

        function updateScrambleScore() {
            scrambleScoreEl.textContent = `Score: ${scrambleScore}`;
        }
        
        function startSpellingBeeGame() {
            [gameMenuView, matchingGameContainer, hangmanGameContainer, wordScrambleGameContainer].forEach(v => v.classList.add('hidden'));
            spellingBeeGameContainer.classList.remove('hidden');
            spellingBeeScore = 0;
            spellingBeeLives = SPELLING_BEE_MAX_LIVES;
            updateSpellingBeeStats();
            nextSpellingBeeWord();
        }

        function nextSpellingBeeWord() {
            if (flashcards.length === 0) {
                showNotification("No cards in this unit to play Spelling Bee.", true);
                switchMode('games');
                return;
            }
            spellingBeeCardToGuess = flashcards[Math.floor(Math.random() * flashcards.length)];
            spellingBeeHint.textContent = `Hint: ${spellingBeeCardToGuess.arabicMeaning}`;
            spellingGuessInput.value = '';
            spellingGuessInput.disabled = false;
            spellingGuessInput.focus();
            [submitSpellingBtn, skipSpellingBtn].forEach(b => b.disabled = false);

            setTimeout(() => {
                 pronounceText(spellingBeeCardToGuess.word, 'en-US');
            }, 500);
        }

        function checkSpellingGuess() {
            const guess = spellingGuessInput.value.trim().toLowerCase();
            if (!guess) return;

            const correctWord = spellingBeeCardToGuess.word.toLowerCase();
            const isCorrect = guess === correctWord;
            
            [submitSpellingBtn, skipSpellingBtn, spellingGuessInput].forEach(el => el.disabled = true);

            if (isCorrect) {
                spellingBeeScore++;
                updateSpellingBeeStats();
                const details = createWordDetailHTML(spellingBeeCardToGuess);
                showNotification(`‚úÖ Correct!${details}`, false, 4000);
                setTimeout(nextSpellingBeeWord, 4000);
            } else {
                spellingBeeLives--;
                updateSpellingBeeStats();
                const details = createWordDetailHTML(spellingBeeCardToGuess);
                showNotification(`‚ùå Incorrect. The word was: ${spellingBeeCardToGuess.word}${details}`, true, 5000);
                
                spellingGuessInput.style.animation = 'shake 0.5s';
                setTimeout(() => spellingGuessInput.style.animation = '', 500);

                if (spellingBeeLives > 0) {
                    setTimeout(nextSpellingBeeWord, 5000);
                } else {
                    endSpellingBeeGame(false);
                }
            }
        }
        
        function updateSpellingBeeStats() {
            spellingBeeScoreEl.textContent = `Score: ${spellingBeeScore}`;
            spellingBeeLivesEl.textContent = `Lives: ${spellingBeeLives} ‚ù§Ô∏è`;
        }

        function endSpellingBeeGame(won) {
            const message = won ? "üéâ Congratulations! You completed the spelling bee!" : "üò≠ Game Over! Better luck next time.";
            showNotification(message, !won, 6000);
            [submitSpellingBtn, skipSpellingBtn, spellingGuessInput].forEach(el => el.disabled = true);
        }

    </script>
</body>
</html>

